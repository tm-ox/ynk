---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

const events = await getCollection("events");
events.sort((b, a) => Date.parse(a.data.date) - Date.parse(b.data.date));
const images = [...new Set(events.map((event) => event.data.images).flat())];
---

<section>
  <div class="relative h-[600px] w-[80%] mx-auto">
    <!-- Lightbox -->
    <button class="carouselButton left is-hidden">&#8656;</button>
    <div class="bg-slate-400 relative h-full overflow-hidden">
      <ul class="carousel relative h-full p-0 m-0 list-none transition">
        {
          images.map((image: any) => (
            <l1
              class={`${image.data} carousel__slide absolute top-0 bottom-0 w-full`}
            >
              <Image
                src={image.src}
                alt={image.alt}
                class="w-full h-full object-cover bg-slate-600"
              />
            </l1>
          ))
        }
      </ul>
    </div>
    <button class="carouselButton right">&#8658;</button>
    <!-- Gallery -->
    <div class="imageGrid grid grid-cols-6 gap-3 bg-orange-300">
      {
        images.map((image: any) => (
          <button class="cursor-pointer">
            <Image src={image.src} alt={image.alt} class="rounded-lg" />
          </button>
        ))
      }
    </div>
  </div>
</section>

<script is:inline>
const carousel = document.querySelector(".carousel");
const slides = Array.from(carousel.children);
const nextButton = document.querySelector(".right");
const prevButton = document.querySelector(".left");
const imageGrid = document.querySelector(".imageGrid");
const imageGridImage = Array.from(imageGrid.children);
const slideWidth = slides[0].getBoundingClientRect().width;
// arrange
const setSlidePosition = (slide, index) => {
  slide.style.left = slideWidth * index + "px";
};
slides.forEach(setSlidePosition);
// move
const moveToSlide = (carousel, active, targetSlide) => {
  carousel.style.transform = "translateX(-" + targetSlide.style.left + ")";
  active.classList.remove("active");
  targetSlide.classList.add("active");
};
// arrow visability
const arrowVis = (slides, prevButton, nextButton, targetIndex) => {
  if (targetIndex === 0) {
    prevButton.classList.add("is-hidden");
    nextButton.classList.remove("is-hidden");
  } else if (targetIndex === slides.length - 1) {
    prevButton.classList.remove("is-hidden");
    nextButton.classList.add("is-hidden");
  } else {
    prevButton.classList.remove("is-hidden");
    nextButton.classList.remove("is-hidden");
  }
};
// prev
prevButton.addEventListener("click", (e) => {
  const active = carousel.querySelector(".active");
  const prevSlide = active.previousElementSibling;
  const prevIndex = slides.findIndex((slide) => slide === prevSlide);
  moveToSlide(carousel, active, prevSlide);
  arrowVis(slides, prevButton, nextButton, prevIndex);
});
// next
nextButton.addEventListener("click", (e) => {
  const active = carousel.querySelector(".active");
  const nextSlide = active.nextElementSibling;
  const nextIndex = slides.findIndex((slide) => slide === nextSlide);
  moveToSlide(carousel, active, nextSlide);
  arrowVis(slides, prevButton, nextButton, nextIndex);
});
// imageGrid
imageGrid.addEventListener("click", (e) => {
  const targetImage = e.target.closest("button");
  if (!targetImage) return;
  const active = carousel.querySelector(".active");
  const targetIndex = imageGridImage.findIndex(
    (image) => image === targetImage
  );
  const targetSlide = slides[targetIndex];
  moveToSlide(carousel, active, targetSlide);
  arrowVis(slides, prevButton, nextButton, targetIndex);
});
</script>

<style>
  .carouselButton {
    @apply absolute top-[50%] -translate-y-[50%] bg-slate-300 rounded-full text-4xl z-50;
  }
  .left {
    @apply -left-[40px];
  }
  .right {
    @apply -right-[40px];
  }
  .is-hidden {
    @apply hidden;
  }
</style>
